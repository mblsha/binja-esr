name: LLAMA Perfetto Smoke

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

jobs:
  perfetto-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: Install dependencies
        run: |
          uv sync --extra dev

      - name: Build Rust core (LLAMA)
        env:
          FORCE_BINJA_MOCK: 1
        run: |
          uv pip install maturin
          uv run maturin develop --manifest-path sc62015/rustcore/Cargo.toml

      - name: Perfetto smoke (NOP + CALL + EMEM MV + DSBL + EMEM reg-indirect + PUSH)
        env:
          FORCE_BINJA_MOCK: 1
        run: |
          # NOP, CALL, EMEM MV, DSBL, EMEM reg-indirect MV, and PUSH parity runs with Perfetto traces, then compare
          uv run python - <<'PY'
from sc62015.core.llama import parity
from pathlib import Path
import subprocess, sys

root = Path(__file__).resolve().parents[2]
workdir = root / "target" / "llama-perfetto-smoke"
workdir.mkdir(parents=True, exist_ok=True)

def run_case(bytes_, pc, op_index):
    llama, py, llama_trace, py_trace, _ = parity.run_parity_once(bytes_, [], pc, op_index, workdir)
    print(f"bytes={bytes_} pc={pc} llama regs", llama.regs)
    print(f"bytes={bytes_} pc={pc} python regs", py.regs)
    cmd = ["python3", str(root / "scripts" / "compare_perfetto_traces.py"), str(py_trace), str(llama_trace)]
    res = subprocess.run(cmd, capture_output=True, text=True)
    print(res.stdout)
    if res.returncode != 0:
        print(res.stderr)
        sys.exit(res.returncode)

run_case([0x00], 0, 0)              # NOP
run_case([0x04, 0x00, 0x10], 0, 1)  # CALL 0x1000
run_case([0xA8, 0x34], 0, 2)        # MV [0x34]->A via EMemAddrWidth(1)
run_case([0xD4, 0x01, 0x02], 0, 3)  # DSBL IMem8, IMem8
run_case([0xB0, 0x20], 0, 4)        # MV [r3],A with reg-indirect (X) simple mode
run_case([0x28], 0, 5)              # PUSHU A
run_case([0x62, 0x00, 0x00, 0x07, 0x00], 0, 6)  # CMP [abs], imm8 to exercise external reads
PY
